import sqlite3
from collections import defaultdict

DB_PATH = "../bd/my_database.db"

ACTION_WEIGHTS = {
    "–ü—Ä–∏–≥–æ—Ç–æ–≤–∏–ª —Ä–µ—Ü–µ–ø—Ç": 3,
    "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤":2,
    "–î–æ–±–∞–≤–ª–µ–Ω —Ä–µ—Ü–µ–ø—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ": 3,
    "–£–¥–∞–ª–µ–Ω —Ä–µ—Ü–µ–ø—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ": -2,
}

def evaluate_prompt_quality():
    con = sqlite3.connect(DB_PATH)
    cursor = con.cursor()

    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞: prompt ‚Üí {action ‚Üí count}
    prompt_actions = defaultdict(lambda: defaultdict(int))

    try:
        cursor.execute("SELECT prompt_name, user_action FROM PromptUsage")
        rows = cursor.fetchall()

        for prompt_name, user_action in rows:
            action = user_action.strip()
            prompt_actions[prompt_name][action] += 1

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    finally:
        con.close()

    # –ü–æ–¥—Å—á—ë—Ç –±–∞–ª–ª–æ–≤
    print("üìä –û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º:")
    print("{:<10} {:>10} {:>10} {:>10}".format("–ü—Ä–æ–º–ø—Ç", "–ë–∞–ª–ª—ã", "–î–µ–π—Å—Ç–≤–∏–π", "–°—Ä–µ–¥–Ω–µ–µ"))
    print("-" * 42)

    for prompt, actions in prompt_actions.items():
        total_score = 0
        total_count = 0
        for action, count in actions.items():
            weight = ACTION_WEIGHTS.get(action, 0)
            total_score += weight * count
            total_count += count
        avg_score = round(total_score / total_count, 2) if total_count else 0
        print("{:<10} {:>10} {:>10} {:>10}".format(prompt, round(total_score, 2), total_count, avg_score))

# –ó–∞–ø—É—Å–∫
evaluate_prompt_quality()
